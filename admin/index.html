<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Back-Office ODC - Administration</title>
    <link rel="stylesheet" href="css/admin.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Variables d'environnement (doit √™tre charg√© avant supabase.js) -->
    <script src="../env.js"></script>
    <script src="../config/supabase.js"></script>
    <script src="js/auth.js"></script>
</head>
<body style="display: none;">
    <!-- Protection d'authentification -->
    <div id="authLoader" style="text-align: center; padding: 3rem; font-family: 'Open Sans', sans-serif;">
        <i class="fas fa-shield-alt" style="font-size: 3rem; color: #FF7900; margin-bottom: 1rem;"></i>
        <h2 style="color: #333;">V√©rification des permissions...</h2>
        <p style="color: #666;">Patientez pendant que nous v√©rifions votre authentification.</p>
    </div>
    
    <script>
        // PROTECTION STRICTE - Bloquer l'acc√®s par d√©faut
        let authenticationPassed = false;
        
        // Prot√©ger la page avant de charger le contenu
        (async function() {
            const loader = document.getElementById('authLoader');
            
            try {
                // V√©rifier que les scripts d'authentification sont charg√©s
                if (typeof protectAdminPage !== 'function') {
                    throw new Error('Script d\'authentification non charg√©');
                }
                
                console.log('üîê V√©rification de l\'authentification...');
                const isAuthenticated = await protectAdminPage();
                
                if (!isAuthenticated) {
                    console.log('‚ùå Authentification √©chou√©e');
                    loader.innerHTML = `
                        <i class="fas fa-lock" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i>
                        <h2 style="color: #dc3545;">Acc√®s non autoris√©</h2>
                        <p style="color: #666;">Redirection vers la page de connexion...</p>
                    `;
                    // Redirection forc√©e
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }
                
                console.log('‚úÖ Authentification r√©ussie');
                authenticationPassed = true;
                
                // Si authentifi√©, masquer le loader et afficher le contenu
                loader.style.display = 'none';
                document.body.style.display = 'block';
                
            } catch (error) {
                console.error('‚ùå Erreur d\'authentification:', error);
                loader.innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ffc107; margin-bottom: 1rem;"></i>
                    <h2 style="color: #ffc107;">Erreur de s√©curit√©</h2>
                    <p style="color: #666;">Redirection vers la page de connexion...</p>
                `;
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 3000);
            }
        })();
        
        // Protection suppl√©mentaire - v√©rifier p√©riodiquement
        setInterval(() => {
            if (!authenticationPassed) {
                console.warn('‚ö†Ô∏è Tentative d\'acc√®s non autoris√© d√©tect√©e');
                window.location.href = 'login.html';
            }
        }, 5000);
    </script>
    <!-- Sidebar Navigation -->
    <div class="admin-layout">
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="admin-logo">
                    <div class="logo-orange-square">
                        <span class="logo-orange-text">orange</span>
                    </div>
                    <div class="logo-text">
                        <span class="admin-title">Admin ODC</span>
                    </div>
                </div>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#dashboard" class="nav-link" data-page="dashboard">
                        <i class="fas fa-dashboard"></i>
                        <span>Tableau de bord</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#formations" class="nav-link" data-page="formations">
                        <i class="fas fa-graduation-cap"></i>
                        <span>Formations</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#events" class="nav-link" data-page="events">
                        <i class="fas fa-calendar-alt"></i>
                        <span>√âv√©nements</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#settings" class="nav-link" data-page="settings">
                        <i class="fas fa-cog"></i>
                        <span>Param√®tres</span>
                    </a>
                </li>
                <li class="nav-item">
                    <button class="nav-link diagnostic-btn" onclick="runODCDiagnostics()" style="border: none; background: none; width: 100%; text-align: left; cursor: pointer; color: inherit; padding: 0.75rem 1.5rem;">
                        <i class="fas fa-stethoscope"></i>
                        <span>Diagnostic syst√®me</span>
                    </button>
                </li>
                <li class="nav-item">
                    <a href="../index.html" class="nav-link" target="_blank">
                        <i class="fas fa-external-link-alt"></i>
                        <span>Voir le site</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Top Header -->
            <header class="content-header">
                <div class="header-left">
                    <button class="sidebar-toggle" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title" id="pageTitle">Tableau de bord</h1>
                </div>
                
                <div class="header-right">
                    <div class="header-actions">
                        <button class="btn btn-outline-secondary" id="testStorageBtn" title="Tester la connexion Supabase Storage">
                            <i class="fas fa-cloud-upload-alt"></i>
                            Test Stockage
                        </button>
                        <button class="btn btn-outline-info" id="testEventsBtn" title="Tester le chargement des √©v√©nements">
                            <i class="fas fa-calendar-check"></i>
                            Test √âv√©nements
                        </button>
                        <button class="btn btn-primary" id="addNewBtn">
                            <i class="fas fa-plus"></i>
                            Ajouter
                        </button>
                    </div>
                </div>
            </header>

            <!-- Content Pages -->
            <div class="content-wrapper">
                <!-- Dashboard Page -->
                <div id="dashboard-page" class="content-page active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-graduation-cap"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="totalFormations">0</h3>
                                <p>Formations actives</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="totalEvents">0</h3>
                                <p>√âv√©nements programm√©s</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="totalParticipants">0</h3>
                                <p>Participants inscrits</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-building"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="totalCenters">4</h3>
                                <p>Centres ODC</p>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-grid">
                        <div class="dashboard-section">
                            <h3>Activit√©s r√©centes</h3>
                            <div class="recent-activities" id="recentActivities">
                                <!-- Activities will be loaded here -->
                            </div>
                        </div>
                        
                        <div class="dashboard-section">
                            <h3>Prochains √©v√©nements</h3>
                            <div class="upcoming-events" id="upcomingEvents">
                                <!-- Upcoming events will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formations Page -->
                <div id="formations-page" class="content-page">
                    <div class="page-controls">
                        <div class="search-bar">
                            <i class="fas fa-search"></i>
                            <input type="text" placeholder="Rechercher une formation..." id="searchFormations">
                        </div>
                        <div class="filter-controls">
                            <select id="categoryFilter">
                                <option value="">Toutes les cat√©gories</option>
                                <option value="ecole-du-code">√âcole du Code</option>
                                <option value="fablab">FabLab</option>
                            </select>
                            <select id="cityFilter">
                                <option value="">Toutes les villes</option>
                                <option value="rabat">Rabat</option>
                                <option value="agadir">Agadir</option>
                                <option value="benmisk">Ben M'sik</option>
                                <option value="sidimaarouf">Sidi Maarouf</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="data-table-container">
                        <table class="data-table" id="formationsTable">
                            <thead>
                                <tr>
                                    <th>Titre</th>
                                    <th>Cat√©gorie</th>
                                    <th>Date</th>
                                    <th>Lieu</th>
                                    <th>Participants</th>
                                    <th>Inscription</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="formationsTableBody">
                                <!-- Formations data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Events Page -->
                <div id="events-page" class="content-page">
                    <div class="page-controls">
                        <div class="search-bar">
                            <i class="fas fa-search"></i>
                            <input type="text" placeholder="Rechercher un √©v√©nement..." id="searchEvents">
                        </div>
                        <div class="filter-controls">
                            <select id="eventsCityFilter">
                                <option value="">Toutes les villes</option>
                                <option value="rabat">Rabat</option>
                                <option value="agadir">Agadir</option>
                                <option value="benmisk">Ben M'sik</option>
                                <option value="sidimaarouf">Sidi Maarouf</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="data-table-container">
                        <table class="data-table" id="eventsTable">
                            <thead>
                                <tr>
                                    <th>Titre</th>
                                    <th>Date</th>
                                    <th>Heure</th>
                                    <th>Lieu</th>
                                    <th>Participants</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="eventsTableBody">
                                <!-- Events data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Settings Page -->
                <div id="settings-page" class="content-page">
                    <div class="settings-grid">
                        <div class="settings-section">
                            <h3>Param√®tres g√©n√©raux</h3>
                            <form id="generalSettingsForm">
                                <div class="form-group">
                                    <label for="siteTitle">Titre du site</label>
                                    <input type="text" id="siteTitle" name="siteTitle" placeholder="Orange Digital Center - Formations & √âv√©nements du Mois">
                                </div>
                                
                                <div class="form-group">
                                    <label for="siteDescription">Description</label>
                                    <textarea id="siteDescription" name="siteDescription" rows="3" placeholder="D√©veloppez vos comp√©tences digitales avec l'Orange Digital Center"></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label for="heroTitle">Titre Hero</label>
                                    <input type="text" id="heroTitle" name="heroTitle" placeholder="D√©veloppez vos comp√©tences digitales">
                                </div>
                                
                                <div class="form-group">
                                    <label for="heroSubtitle">Sous-titre Hero</label>
                                    <textarea id="heroSubtitle" name="heroSubtitle" rows="2" placeholder="D√©couvrez nos formations et √©v√©nements dans tous nos centres Orange Digital Center"></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label for="contactEmail">Email de contact</label>
                                    <input type="email" id="contactEmail" name="contactEmail" placeholder="contact@orangedigitalcenter.ma">
                                </div>
                                
                                <button type="submit" class="btn btn-primary">Enregistrer les param√®tres</button>
                            </form>
                        </div>
                        
                        <div class="settings-section">
                            <h3>Centres ODC</h3>
                            <div id="odcCentersList">
                                <!-- ODC Centers will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal for Add/Edit -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Ajouter une formation</h3>
                <button class="modal-close" id="modalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Form content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Charger les scripts dans le bon ordre -->
    <script src="js/admin-supabase.js"></script>
    <script src="js/diagnostic.js"></script>
    
    <!-- Initialiser apr√®s que l'authentification soit OK -->
    <script>
        // Attendre que l'authentification soit valid√©e et que SupabaseAPI soit disponible
        window.addEventListener('load', async function() {
            // V√©rifier que SupabaseAPI est disponible
            if (window.SupabaseAPI) {
                console.log('‚úÖ SupabaseAPI disponible, initialisation du back office');
                // L'initialisation se fait automatiquement dans admin-supabase.js
            } else {
                console.error('‚ùå SupabaseAPI non disponible');
                // Essayer de charger manuellement
                setTimeout(() => {
                    if (typeof initializeDashboard === 'function') {
                        initializeDashboard();
                    }
                }, 1000);
            }
        });
    </script>
</body>
</html>
